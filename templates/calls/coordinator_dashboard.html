{% extends 'dashboard_base.html' %}

{% block title %}Call Management - ReDIB COA Portal{% endblock %}

{% block sidebar_call_mgmt_active %}active{% endblock %}

{% block dashboard_content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-folder"></i> Call Management</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'calls:create' %}" class="btn btn-success">
            <i class="bi bi-plus-circle"></i> Create New Call
        </a>
    </div>
</div>

{% if calls %}
<div class="table-responsive">
    <table class="table table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th>Code</th>
                <th>Title</th>
                <th>Status</th>
                <th>Submission Period</th>
                <th>Equipment</th>
                <th>Applications</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for call in calls %}
            <tr>
                <td><strong>{{ call.code }}</strong></td>
                <td>{{ call.title|truncatewords:8 }}</td>
                <td>
                    {% if call.status == 'draft' %}
                    <span class="badge bg-secondary">Draft</span>
                    {% elif call.status == 'open' %}
                    <span class="badge bg-success">Open</span>
                    {% elif call.status == 'closed' %}
                    <span class="badge bg-warning">Closed</span>
                    {% elif call.status == 'resolved' %}
                    <span class="badge bg-info">Resolved</span>
                    {% endif %}
                </td>
                <td>
                    <small>
                        {{ call.submission_start|date:"M d" }} - {{ call.submission_end|date:"M d, Y" }}
                    </small>
                </td>
                <td>
                    <span class="badge bg-light text-dark">{{ call.equipment_allocations.count }} items</span>
                </td>
                <td>
                    {% if call.application_count %}
                    <span class="badge bg-primary">{{ call.application_count }}</span>
                    {% else %}
                    <span class="text-muted">0</span>
                    {% endif %}
                </td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <a href="{% url 'calls:detail' call.pk %}" class="btn btn-outline-primary" title="View Details">
                            <i class="bi bi-eye"></i>
                        </a>
                        <a href="{% url 'calls:call_edit' call.pk %}" class="btn btn-outline-secondary" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </a>

                        {% if call.status == 'draft' %}
                        <a href="{% url 'calls:publish' call.pk %}" class="btn btn-outline-success"
                           onclick="return confirm('Publish this call? This will notify users.')" title="Publish">
                            <i class="bi bi-send"></i>
                        </a>
                        {% elif call.status == 'open' %}
                        <a href="{% url 'calls:close' call.pk %}" class="btn btn-outline-warning"
                           onclick="return confirm('Close this call for submissions?')" title="Close">
                            <i class="bi bi-lock"></i>
                        </a>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="mt-3">
    <p class="text-muted">
        <i class="bi bi-info-circle"></i>
        Total: {{ calls.count }} call{{ calls.count|pluralize }}
    </p>
</div>
{% else %}
<div class="alert alert-info">
    <h4 class="alert-heading"><i class="bi bi-info-circle"></i> No Calls Yet</h4>
    <p>You haven't created any calls yet. Create your first call to get started.</p>
    <hr>
    <a href="{% url 'calls:create' %}" class="btn btn-success">
        <i class="bi bi-plus-circle"></i> Create First Call
    </a>
</div>
{% endif %}

<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-question-circle"></i> Call Status Guide</h5>
    </div>
    <div class="card-body">
        <ul class="list-unstyled mb-0">
            <li class="mb-2">
                <span class="badge bg-secondary">Draft</span> - Call is being prepared, not visible to applicants
            </li>
            <li class="mb-2">
                <span class="badge bg-success">Open</span> - Call is published and accepting applications
            </li>
            <li class="mb-2">
                <span class="badge bg-warning">Closed</span> - Submission period ended, ready for evaluation
            </li>
            <li class="mb-0">
                <span class="badge bg-info">Resolved</span> - Evaluations complete, decisions communicated
            </li>
        </ul>
    </div>
</div>
{% endblock %}
