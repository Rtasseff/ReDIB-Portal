{% extends 'dashboard_base.html' %}

{% block title %}Resolution Review: {{ application.code }} - ReDIB{% endblock %}

{% block dashboard_content %}
<div class="container-fluid">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'applications:node_resolution_queue' %}">Resolution Queue</a></li>
            <li class="breadcrumb-item active">{{ application.code }}</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">Resolution Review: {{ application.code }}</h1>
        <span class="badge bg-info fs-5">Node: {{ node.code }}</span>
    </div>

    {% if application.has_competitive_funding %}
    <div class="alert alert-success mb-4">
        <i class="bi bi-award"></i>
        <strong>Competitive Funding:</strong> This application has competitive funding. You may accept or waitlist, but cannot reject.
    </div>
    {% endif %}

    <div class="alert alert-warning mb-4">
        <i class="bi bi-exclamation-triangle"></i>
        <strong>Important:</strong> Review the application details, evaluation scores, and make your resolution decision.
        Set approved hours for each equipment item from your node.
    </div>

    <!-- Application Overview -->
    <div class="card mb-3">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Application Overview</h5>
        </div>
        <div class="card-body">
            <dl class="row mb-0">
                <dt class="col-sm-3">Call</dt>
                <dd class="col-sm-9">{{ application.call.code }} - {{ application.call.name }}</dd>

                <dt class="col-sm-3">Applicant Name</dt>
                <dd class="col-sm-9">{{ application.applicant_name|default:"N/A" }}</dd>

                <dt class="col-sm-3">ORCID</dt>
                <dd class="col-sm-9">{{ application.applicant_orcid|default:"N/A" }}</dd>

                <dt class="col-sm-3">Entity</dt>
                <dd class="col-sm-9">{{ application.applicant_entity|default:"N/A" }}</dd>

                <dt class="col-sm-3">Submitted</dt>
                <dd class="col-sm-9">{{ application.submitted_at|date:"F d, Y H:i" }}</dd>

                <dt class="col-sm-3">Brief Description</dt>
                <dd class="col-sm-9">{{ application.brief_description }}</dd>
            </dl>
        </div>
    </div>

    <!-- Evaluation Scores -->
    <div class="card mb-3">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-graph-up"></i> Evaluation Scores</h5>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="card text-center bg-light">
                        <div class="card-body">
                            <h2 class="text-primary mb-0">
                                {% if application.final_score %}
                                    {{ application.final_score|floatformat:1 }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </h2>
                            <small class="text-muted">Final Score (Average)</small>
                        </div>
                    </div>
                </div>
            </div>

            {% if evaluations %}
            <h6>Individual Evaluator Scores:</h6>
            <div class="table-responsive">
                <table class="table table-sm table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>Evaluator</th>
                            <th>Score</th>
                            <th>Evaluated At</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for eval in evaluations %}
                        <tr>
                            <td>{{ eval.evaluator.get_full_name|default:eval.evaluator.email }}</td>
                            <td>
                                {% if eval.total_score %}
                                    <span class="badge bg-primary">{{ eval.total_score|floatformat:1 }}</span>
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>{{ eval.evaluated_at|date:"M d, Y H:i"|default:"Not completed" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">No evaluations recorded yet.</p>
            {% endif %}
        </div>
    </div>

    <!-- Equipment Requested at This Node -->
    <div class="card mb-3">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0"><i class="bi bi-cpu"></i> Equipment at {{ node.code }}</h5>
        </div>
        <div class="card-body">
            {% if node_equipment %}
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>Equipment</th>
                            <th>Hours Requested</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for access in node_equipment %}
                        <tr>
                            <td><strong>{{ access.equipment.name }}</strong></td>
                            <td>{{ access.hours_requested }} hours</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted mb-0">No equipment requested at this node.</p>
            {% endif %}
        </div>
    </div>

    <!-- Project Information -->
    <div class="card mb-3">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Project Information</h5>
        </div>
        <div class="card-body">
            <dl class="row mb-0">
                <dt class="col-sm-3">Project Title</dt>
                <dd class="col-sm-9">{{ application.project_title|default:"N/A" }}</dd>

                <dt class="col-sm-3">Project Type</dt>
                <dd class="col-sm-9">{{ application.get_project_type_display }}</dd>

                <dt class="col-sm-3">Subject Area</dt>
                <dd class="col-sm-9">{{ application.get_subject_area_display }}</dd>

                <dt class="col-sm-3">Service Modality</dt>
                <dd class="col-sm-9">{{ application.get_service_modality_display }}</dd>

                <dt class="col-sm-3">Specialization</dt>
                <dd class="col-sm-9">{{ application.get_specialization_area_display }}</dd>
            </dl>
        </div>
    </div>

    <!-- Scientific Content -->
    <div class="card mb-3">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Scientific Content</h5>
        </div>
        <div class="card-body">
            <h6>Methodology and Experimental Design</h6>
            <p class="text-pre-wrap">{{ application.methodology_description|default:"N/A" }}</p>

            <h6 class="mt-3">Scientific Relevance</h6>
            <p class="text-pre-wrap">{{ application.scientific_relevance|default:"N/A"|truncatewords:150 }}</p>

            <h6 class="mt-3">Expected Contributions</h6>
            <p class="text-pre-wrap">{{ application.expected_contributions|default:"N/A"|truncatewords:100 }}</p>
        </div>
    </div>

    <!-- Resolution Form -->
    <div class="card border-danger mb-4">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0"><i class="bi bi-check2-square"></i> Your Resolution Decision</h5>
        </div>
        <div class="card-body">
            {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
            {% endif %}

            <form method="post">
                {% csrf_token %}

                <!-- Hours Approved per Equipment -->
                <div class="mb-4">
                    <h6><i class="bi bi-clock"></i> Approved Hours per Equipment</h6>
                    <p class="text-muted small">Set the approved hours for each equipment. Can be less than or equal to requested hours.</p>

                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Equipment</th>
                                    <th>Hours Requested</th>
                                    <th>Hours Approved</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for eq in equipment_forms %}
                                <tr>
                                    <td>
                                        <strong>{{ eq.equipment_name }}</strong>
                                        <input type="hidden" name="equipment_id_{{ eq.equipment_id }}" value="{{ eq.equipment_id }}">
                                    </td>
                                    <td>{{ eq.hours_requested }} hours</td>
                                    <td>
                                        <input type="number"
                                               name="hours_approved_{{ eq.equipment_id }}"
                                               value="{{ eq.hours_approved }}"
                                               min="0"
                                               max="{{ eq.hours_requested }}"
                                               step="0.5"
                                               class="form-control form-control-sm"
                                               style="width: 100px;"
                                               required>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-muted text-center">No equipment from this node</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Resolution Choice -->
                <div class="mb-4">
                    <label class="form-label"><strong>Resolution Decision *</strong></label>
                    {% for radio in form.resolution %}
                    <div class="form-check">
                        {{ radio.tag }}
                        <label class="form-check-label" for="{{ radio.id_for_label }}">
                            {{ radio.choice_label }}
                        </label>
                    </div>
                    {% endfor %}
                    {% if form.resolution.errors %}
                    <div class="text-danger small">{{ form.resolution.errors }}</div>
                    {% endif %}
                </div>

                <!-- Comments -->
                <div class="mb-4">
                    <label for="{{ form.comments.id_for_label }}" class="form-label">
                        <strong>Comments</strong>
                    </label>
                    {{ form.comments }}
                    {% if form.comments.errors %}
                    <div class="text-danger small">{{ form.comments.errors }}</div>
                    {% endif %}
                    <small class="form-text text-muted">
                        Provide any relevant comments about your decision. These will be aggregated with other nodes' comments.
                    </small>
                </div>

                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>Aggregation Rules:</strong>
                    <ul class="mb-0">
                        <li>If <strong>all</strong> nodes accept: Application is <strong>accepted</strong></li>
                        <li>If <strong>any</strong> node rejects: Application is <strong>rejected</strong></li>
                        <li>If no rejects but any waitlist: Application is <strong>pending (waitlisted)</strong></li>
                    </ul>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <a href="{% url 'applications:node_resolution_queue' %}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Queue
                    </a>
                    <button type="submit" class="btn btn-danger btn-lg"
                            onclick="return confirm('Are you sure you want to submit this resolution?')">
                        <i class="bi bi-send"></i> Submit Resolution
                    </button>
                </div>
            </form>
        </div>
    </div>

    {% if other_node_resolutions %}
    <!-- Other Nodes' Decisions (if any) -->
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="bi bi-diagram-3"></i> Other Nodes' Decisions</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Node</th>
                            <th>Decision</th>
                            <th>Reviewed At</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for nr in other_node_resolutions %}
                        <tr>
                            <td><span class="badge bg-info">{{ nr.node.code }}</span></td>
                            <td>
                                {% if nr.resolution == 'accept' %}
                                    <span class="badge bg-success">Accepted</span>
                                {% elif nr.resolution == 'waitlist' %}
                                    <span class="badge bg-warning text-dark">Waitlisted</span>
                                {% elif nr.resolution == 'reject' %}
                                    <span class="badge bg-danger">Rejected</span>
                                {% else %}
                                    <span class="badge bg-secondary">Pending</span>
                                {% endif %}
                            </td>
                            <td>{{ nr.reviewed_at|date:"M d, Y H:i"|default:"Pending" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
.text-pre-wrap {
    white-space: pre-wrap;
}
</style>
{% endblock %}
