{% extends 'dashboard_base.html' %}

{% block title %}New Application - Step 5 - ReDIB{% endblock %}

{% block dashboard_content %}
<div class="container-fluid">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'calls:public_list' %}">Calls</a></li>
            <li class="breadcrumb-item"><a href="{% url 'calls:public_detail' application.call.pk %}">{{ application.call.code }}</a></li>
            <li class="breadcrumb-item active">Application {{ application.code|default:"DRAFT" }}</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-lg-9">
            <h1 class="mb-4">Application for {{ application.call.code }}</h1>

            <!-- Progress Bar -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="progress" style="height: 30px;">
                        <div class="progress-bar" role="progressbar"
                             style="width: {% widthratio step total_steps 100 %}%;"
                             aria-valuenow="{{ step }}" aria-valuemin="0" aria-valuemax="{{ total_steps }}">
                            Step {{ step }} of {{ total_steps }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Card -->
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Step 5: Declarations & Consent</h5>
                    <button type="button" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#infoModal">
                        <i class="bi bi-info-circle"></i> More Info
                    </button>
                </div>
                <div class="card-body">
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {{ form.non_field_errors }}
                    </div>
                    {% endif %}

                    <form method="post">
                        {% csrf_token %}

                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">Technical Feasibility</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-check">
                                    {{ form.technical_feasibility_confirmed }}
                                    <label class="form-check-label" for="{{ form.technical_feasibility_confirmed.id_for_label }}">
                                        {{ form.technical_feasibility_confirmed.label }}
                                    </label>
                                </div>
                                {% if form.technical_feasibility_confirmed.errors %}
                                <div class="text-danger small">{{ form.technical_feasibility_confirmed.errors }}</div>
                                {% endif %}
                                {% if form.technical_feasibility_confirmed.help_text %}
                                <small class="form-text text-muted d-block mt-2">
                                    {{ form.technical_feasibility_confirmed.help_text }}
                                </small>
                                {% endif %}
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">Animal Use Ethics</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-check mb-2">
                                    {{ form.uses_animals }}
                                    <label class="form-check-label" for="{{ form.uses_animals.id_for_label }}">
                                        {{ form.uses_animals.label }}
                                    </label>
                                </div>
                                {% if form.uses_animals.errors %}
                                <div class="text-danger small">{{ form.uses_animals.errors }}</div>
                                {% endif %}

                                <div class="form-check mt-3">
                                    {{ form.has_animal_ethics }}
                                    <label class="form-check-label" for="{{ form.has_animal_ethics.id_for_label }}">
                                        {{ form.has_animal_ethics.label }}
                                    </label>
                                </div>
                                {% if form.has_animal_ethics.errors %}
                                <div class="text-danger small">{{ form.has_animal_ethics.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted d-block mt-2">
                                    If you use animals, you must have approval from an ethics committee before starting experiments.
                                </small>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">Human Subjects Ethics</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-check mb-2">
                                    {{ form.uses_humans }}
                                    <label class="form-check-label" for="{{ form.uses_humans.id_for_label }}">
                                        {{ form.uses_humans.label }}
                                    </label>
                                </div>
                                {% if form.uses_humans.errors %}
                                <div class="text-danger small">{{ form.uses_humans.errors }}</div>
                                {% endif %}

                                <div class="form-check mt-3">
                                    {{ form.has_human_ethics }}
                                    <label class="form-check-label" for="{{ form.has_human_ethics.id_for_label }}">
                                        {{ form.has_human_ethics.label }}
                                    </label>
                                </div>
                                {% if form.has_human_ethics.errors %}
                                <div class="text-danger small">{{ form.has_human_ethics.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted d-block mt-2">
                                    If you use human subjects, you must have approval from an ethics committee before starting experiments.
                                </small>
                            </div>
                        </div>

                        <div class="card mb-4 border-danger">
                            <div class="card-header bg-danger text-white">
                                <h6 class="mb-0">Data Consent (Required)</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-check">
                                    {{ form.data_consent }}
                                    <label class="form-check-label" for="{{ form.data_consent.id_for_label }}">
                                        {{ form.data_consent.label }}
                                    </label>
                                </div>
                                {% if form.data_consent.errors %}
                                <div class="text-danger small">{{ form.data_consent.errors }}</div>
                                {% endif %}
                                {% if form.data_consent.help_text %}
                                <small class="form-text text-muted d-block mt-2">
                                    {{ form.data_consent.help_text }}
                                </small>
                                {% endif %}
                            </div>
                        </div>

                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i>
                            <strong>Almost done!</strong> After this step, you can preview your complete application and submit it.
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'applications:edit_step4' application.pk %}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> Back
                            </a>
                            <button type="submit" class="btn btn-primary">
                                Next: Preview & Submit <i class="bi bi-arrow-right"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-3">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header">
                    <h6 class="mb-0">Application Steps</h6>
                </div>
                <div class="list-group list-group-flush">
                    <div class="list-group-item">
                        <i class="bi bi-check-circle text-success"></i> <strong>1. Basic Info</strong>
                    </div>
                    <div class="list-group-item">
                        <i class="bi bi-check-circle text-success"></i> <strong>2. Funding & Project</strong>
                    </div>
                    <div class="list-group-item">
                        <i class="bi bi-check-circle text-success"></i> <strong>3. Equipment Request</strong>
                    </div>
                    <div class="list-group-item">
                        <i class="bi bi-check-circle text-success"></i> <strong>4. Scientific Content</strong>
                    </div>
                    <div class="list-group-item active">
                        <strong>5. Declarations</strong>
                    </div>
                    <div class="list-group-item">
                        6. Preview & Submit
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- More Info Modal -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="infoModalLabel">General Information and Instructions for Completing this Form</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>
                    ReDIB infrastructures and services are available to all members of the national and international scientific community,
                    who can access them under the Competitive Open Access (COA) modality, or under the Access on Demand (AOD) modality.
                    In the first case, COA, access to the essential ReDIB facilities is free or with minimal costs for the user
                    (i.e., consumable costs), while in the AOD modality the rates published on the website of the nodes that make up
                    this distributed ICTS apply. ReDIB declares its firm commitment to offer at least 20% of the capacity of its
                    essential facilities in COA mode.
                </p>
                <p>
                    The approval of the COA to the essential ReDIB facilities requires adequate justification that the access proposal
                    complies with sufficient scientific-technical quality. In this sense, the proposals received that are part of R&D&I
                    projects financed by a competitive call from an international or national funding agency will be deemed to meet
                    the required quality, and will therefore be automatically approved, with their access to the ICTS being conditioned
                    by the score obtained in the evaluation and their position on the priority list. Otherwise, if no data is provided
                    on the existence of a competitively funded parent project, the applications will be approved or not based on the
                    relevance and opportunity criteria applied in the evaluation and, once approved, their access is also conditioned
                    by the score obtained.
                </p>
                <p>
                    In all cases, to obtain the corresponding score, which will allow the prioritized list of approved applications
                    with assigned access to be drawn up, all the sections of this access application must be properly completed,
                    which are related to the different criteria that will be assessed by the ReDIB Access Committee, in order to
                    establish the priority of each of the approved accesses in each COA call.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
