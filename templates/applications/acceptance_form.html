{% extends 'dashboard_base.html' %}

{% block title %}Accept/Decline Application - ReDIB COA Portal{% endblock %}

{% block dashboard_content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-check-circle"></i> Accept or Decline Access</h1>
</div>

<!-- Deadline Warning -->
{% if days_remaining %}
<div class="alert {% if days_remaining <= 3 %}alert-danger{% else %}alert-warning{% endif %}">
    <i class="bi bi-clock"></i>
    <strong>Action Required!</strong> You have <strong>{{ days_remaining }} day{{ days_remaining|pluralize }}</strong> remaining to respond.
    Deadline: {{ deadline|date:"F d, Y" }}
</div>
{% endif %}

<!-- Application Details -->
<div class="card mb-4">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0">Your Application Has Been Accepted!</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <p><strong>Application Code:</strong> {{ application.code }}</p>
                <p><strong>Project Title:</strong> {{ application.project_title }}</p>
                <p><strong>Brief Description:</strong> {{ application.brief_description }}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Call:</strong> {{ application.call.code }}</p>
                <p><strong>Final Score:</strong> {{ application.final_score|floatformat:1 }}/12</p>
                {% if application.resolution_comments %}
                <p><strong>Coordinator Comments:</strong></p>
                <div class="bg-light p-2 rounded">{{ application.resolution_comments }}</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Granted Access -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Approved Equipment Access</h5>
    </div>
    <div class="card-body p-0">
        <table class="table table-sm mb-0">
            <thead class="table-light">
                <tr>
                    <th>Node</th>
                    <th>Equipment</th>
                    <th>Hours Granted</th>
                </tr>
            </thead>
            <tbody>
                {% for access in requested_access %}
                <tr>
                    <td>{{ access.equipment.node.name }} ({{ access.equipment.node.code }})</td>
                    <td>{{ access.equipment.name }}</td>
                    <td>
                        <strong>{{ access.hours_approved|default:access.hours_requested }}</strong> hours
                        {% if access.hours_approved and access.hours_approved != access.hours_requested %}
                            <small class="text-muted">(requested: {{ access.hours_requested }})</small>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Decision Form -->
<div class="card mb-4 border-primary">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Your Decision</h5>
    </div>
    <div class="card-body">
        <p>Please confirm whether you wish to accept this access or decline it.</p>

        <div class="row">
            <!-- Accept -->
            <div class="col-md-6">
                <div class="card border-success h-100">
                    <div class="card-body">
                        <h5 class="text-success"><i class="bi bi-check-circle-fill"></i> Accept Access</h5>
                        <p class="text-muted">By accepting, you confirm that:</p>
                        <ul class="text-muted">
                            <li>You will coordinate with node staff to schedule access</li>
                            <li>You will follow all equipment protocols and safety guidelines</li>
                            <li>You will report actual hours used upon completion</li>
                            <li>Node coordinators will be notified and will contact you</li>
                        </ul>
                        <form method="post" class="mt-3">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="accept">
                            <button type="submit" class="btn btn-success btn-lg w-100">
                                <i class="bi bi-check-circle"></i> Accept Access
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Decline -->
            <div class="col-md-6">
                <div class="card border-danger h-100">
                    <div class="card-body">
                        <h5 class="text-danger"><i class="bi bi-x-circle-fill"></i> Decline Access</h5>
                        <p class="text-muted">If you decline this access:</p>
                        <ul class="text-muted">
                            <li>This grant will be cancelled</li>
                            <li>The equipment hours will be available for other researchers</li>
                            <li>You can apply again in future calls</li>
                        </ul>
                        <form method="post" class="mt-3" onsubmit="return confirm('Are you sure you want to decline this access? This action cannot be undone.');">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="decline">
                            <div class="mb-3">
                                <label for="decline_reason" class="form-label">Reason for declining (optional):</label>
                                <textarea class="form-control" name="decline_reason" id="decline_reason" rows="2"
                                          placeholder="e.g., Project timeline changed, obtained access elsewhere..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-outline-danger w-100">
                                <i class="bi bi-x-circle"></i> Decline Access
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="mt-4">
    <a href="{% url 'core:dashboard' %}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
</div>

{% endblock %}
